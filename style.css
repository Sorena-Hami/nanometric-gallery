// --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª ---
const SHEET_ID = '103cZAMY3lFK797NZ3-BforE30EZWXydOpGewxrlP4FI';
const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv`;

const CONTACT = {
    phone: "09304653535",
    wa: "989304653535",
    tg: "Official_iDirect",
    ei: "Official_iDirect",
    ba: "Official_iDirect",
    ru: "Official_iDirect",
    ig: "nanometriclab"
};

let portfolioData = [];
let cart = [];
let marketerCode = "";
let panzoomInstance = null;

// 1. Ø§Ø³ØªØ§Ø±Øª Ø¢Ù¾
window.onload = async () => {
    // Ø¨Ø§Ø²Ø§Ø±ÛŒØ§Ø¨
    const urlParams = new URLSearchParams(window.location.search);
    if(urlParams.has('ref')) {
        marketerCode = urlParams.get('ref');
        sessionStorage.setItem('nano_ref', marketerCode);
    } else {
        marketerCode = sessionStorage.getItem('nano_ref') || "";
    }

    try {
        const res = await fetch(SHEET_URL);
        const text = await res.text();
        portfolioData = parseCSV(text);
        
        document.getElementById('loading-overlay').style.display = 'none';
        
        initSlider();
        renderFolderTabs();
        filterData('Ù‡Ù…Ù‡'); // Ù†Ù…Ø§ÛŒØ´ Ø§ÙˆÙ„ÛŒÙ‡

        // Ù‡Ø´Ø¯Ø§Ø± Ø®Ø±ÙˆØ¬
        window.onbeforeunload = function() {
            return "Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø®Ø§Ø±Ø¬ Ø´ÙˆÛŒØ¯ØŸ";
        };

    } catch (e) {
        console.error("Error loading data", e);
        document.getElementById('loading-overlay').innerHTML = "<p>Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ. Ù„Ø·ÙØ§ Ù…Ø¬Ø¯Ø¯ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.</p>";
    }
};

// 2. Ù¾Ø§Ø±Ø³Ø± + Ø¢Ù…Ø§Ø± ØªØµØ§Ø¯ÙÛŒ
function parseCSV(csv) {
    const lines = csv.split('\n');
    const result = [];
    for (let i = 1; i < lines.length; i++) {
        const row = lines[i].match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
        if (!row) continue;
        const c = row.map(val => val.replace(/^"|"$/g, '').trim());

        if (c.length >= 2 && c[1].startsWith('http')) {
            // ØªÙˆÙ„ÛŒØ¯ Ø¢Ù…Ø§Ø± ÙÛŒÚ© Ø¨Ø± Ø§Ø³Ø§Ø³ Ú©Ø¯ Ø¹Ú©Ø³ (Ø«Ø§Ø¨Øª Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø¹Ú©Ø³)
            const idNum = 1000 + i;
            const views = Math.floor((idNum * 13) % 5000) + 500;
            const likes = Math.floor(views * 0.15);
            
            result.push({
                id: `NANO-${idNum}`,
                cat: c[0], img: c[1],
                price: c[2] || "0", discount: c[3] || "0",
                title: c[4] || `Ø·Ø±Ø­ Ø´Ù…Ø§Ø±Ù‡ ${idNum}`,
                desc: c[5] || "",
                stats: { views, likes }
            });
        }
    }
    return result;
}

// 3. Ø§Ø³Ù„Ø§ÛŒØ¯Ø± ØªØµØ§Ø¯ÙÛŒ
function initSlider() {
    const wrapper = document.getElementById('slider-wrapper');
    // Ø´Ø§ÙÙ„ Ú©Ø±Ø¯Ù† Ùˆ Ø¨Ø±Ø¯Ø§Ø´ØªÙ† 5 ØªØ§
    const shuffled = [...portfolioData].sort(() => 0.5 - Math.random()).slice(0, 5);
    
    shuffled.forEach(item => {
        wrapper.innerHTML += `
            <div class="swiper-slide">
                <img src="${item.img}" alt="${item.title}">
                <div class="slide-caption">${item.title}</div>
            </div>`;
    });

    new Swiper(".mySwiper", {
        loop: true, autoplay: { delay: 4000 },
        pagination: { el: ".swiper-pagination" },
    });
}

// 4. ØªØ¨â€ŒÙ‡Ø§
function renderFolderTabs() {
    const cats = ['Ù‡Ù…Ù‡', ...new Set(portfolioData.map(p => p.cat))];
    const con = document.getElementById('tagContainer');
    con.innerHTML = '';
    cats.forEach(cat => {
        const sample = cat === 'Ù‡Ù…Ù‡' ? portfolioData[0] : portfolioData.find(p => p.cat === cat);
        con.innerHTML += `
            <div class="folder-tab ${cat === 'Ù‡Ù…Ù‡' ? 'active' : ''}" onclick="changeTab(this, '${cat}')">
                <img src="${sample ? sample.img : ''}"> ${cat}
            </div>`;
    });
}
function changeTab(el, cat) {
    document.querySelectorAll('.folder-tab').forEach(e => e.classList.remove('active'));
    el.classList.add('active');
    filterData(cat === 'Ù‡Ù…Ù‡' ? '' : cat);
}

// 5. Ú¯Ø§Ù„Ø±ÛŒ
function filterData(query) {
    const q = query.toLowerCase();
    const data = query === '' 
        ? portfolioData 
        : portfolioData.filter(i => i.cat === query || i.title.toLowerCase().includes(q) || i.id.toLowerCase().includes(q));
    
    // Ø±Ù†Ø¯Ø± Ú¯Ø±ÛŒØ¯
    const grid = document.getElementById('gallery-view');
    grid.innerHTML = '';
    data.forEach(item => {
        const hasOff = item.discount && item.discount !== "0";
        const priceShow = hasOff ? parseInt(item.discount).toLocaleString() : (item.price === "0" ? "" : parseInt(item.price).toLocaleString());
        
        grid.innerHTML += `
            <div class="art-card" onmousedown="startLongPress(this)" onmouseup="cancelLongPress()" onclick="openModal('${item.id}')">
                <div class="card-img-wrap">
                    <img src="${item.img}" loading="lazy">
                    <button class="quick-add-btn" onclick="event.stopPropagation(); addToCart('${item.id}')">+ Ù„ÛŒØ³Øª</button>
                    ${priceShow ? `<span class="card-badge-price">${priceShow} Øª</span>` : ''}
                    <div class="stat-overlay">
                        <span><i class="fas fa-eye"></i> ${item.stats.views}</span>
                        <span><i class="fas fa-heart"></i> ${item.stats.likes}</span>
                    </div>
                </div>
            </div>`;
    });

    // Ø±Ù†Ø¯Ø± Ú©ØªØ§Ø¨ (Ø§Ú¯Ø± Ú©Ù… Ø¨Ø§Ø´Ù†Ø¯)
    initFlipbook(data.slice(0, 30)); // Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø¨Ø±Ø§ÛŒ Ù¾Ø±ÙÙˆØ±Ù…Ù†Ø³
}

// Ø¬Ø³ØªØ¬ÙˆÛŒ Ø²Ù†Ø¯Ù‡
document.getElementById('searchInput').addEventListener('input', (e) => filterData(e.target.value));

// 6. Ú©ØªØ§Ø¨ ÙˆØ±Ù‚ Ø²Ù† (Turn.js)
function initFlipbook(data) {
    const book = $("#flipbook");
    if(book.turn("is")) book.turn("destroy"); // Ø±ÛŒØ³Øª
    book.html(""); // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†

    data.forEach(item => {
        const element = $("<div />").addClass("page").html(`
            <img src="${item.img}" style="max-width:90%; max-height:80%">
            <p style="margin-top:10px">${item.title}</p>
            <small>${item.id}</small>
        `);
        book.append(element);
    });

    book.turn({
        width: 800, height: 500, autoCenter: true,
        when: { turning: () => document.getElementById('page-flip-sound').play() }
    });
}

// 7. Ù…ÙˆØ¯Ø§Ù„ Ùˆ Ø²ÙˆÙ…
let currentItem = null;
function openModal(id) {
    currentItem = portfolioData.find(i => i.id === id);
    if(!currentItem) return;

    document.getElementById('m-img').src = currentItem.img;
    document.getElementById('m-title').innerText = currentItem.title;
    document.getElementById('m-code').innerText = currentItem.id;
    document.getElementById('m-desc').innerText = currentItem.desc || "Ø¨Ø¯ÙˆÙ† ØªÙˆØ¶ÛŒØ­Ø§Øª";
    document.getElementById('m-views').innerText = currentItem.stats.views;
    document.getElementById('m-likes').innerText = currentItem.stats.likes;

    // Ù‚ÛŒÙ…Øª
    const pBox = document.getElementById('m-price-box');
    if(currentItem.discount && currentItem.discount !== "0") {
        pBox.innerHTML = `<span class="old-price">${parseInt(currentItem.price).toLocaleString()}</span> ${parseInt(currentItem.discount).toLocaleString()} ØªÙˆÙ…Ø§Ù†`;
    } else {
        pBox.innerHTML = currentItem.price === "0" ? "ØªÙˆØ§ÙÙ‚ÛŒ" : `${parseInt(currentItem.price).toLocaleString()} ØªÙˆÙ…Ø§Ù†`;
    }

    // Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
    renderSocialButtons(currentItem);
    document.getElementById('detailModal').style.display = 'block';
}

function renderSocialButtons(itemOrList) {
    const container = document.getElementById('socialLinksContainer');
    const platforms = [
        {id:'wa', name:'ÙˆØ§ØªØ³Ø§Ù¾', icon:'https://res.cloudinary.com/dsj7o7yld/image/upload/v1767115995/25-256308_whatsapp-social-media-icons-whatsapp_o9zkit.png'},
        {id:'tg', name:'ØªÙ„Ú¯Ø±Ø§Ù…', icon:'https://res.cloudinary.com/dsj7o7yld/image/upload/v1767113676/telgrampng.parspng.com__rzuqpw.png'},
        {id:'ei', name:'Ø§ÛŒØªØ§', icon:'https://res.cloudinary.com/dsj7o7yld/image/upload/v1767111952/Eitaa-vector-logo_1221133400_we5m5l.png'},
        {id:'ba', name:'Ø¨Ù„Ù‡', icon:'https://res.cloudinary.com/dsj7o7yld/image/upload/v1767112210/bale-color_a9gfhw.png'},
        {id:'ru', name:'Ø±ÙˆØ¨ÛŒÚ©Ø§', icon:'https://res.cloudinary.com/dsj7o7yld/image/upload/v1767112404/Rubika_Icon_zlc48h.png'},
        {id:'ig', name:'Ø§ÛŒÙ†Ø³ØªØ§', icon:'https://res.cloudinary.com/dsj7o7yld/image/upload/v1767116766/050e6fb1-f306-4571-a198-61f15806718e_1_ln8bgv.png'}
    ];
    
    container.innerHTML = platforms.map(p => `
        <button onclick="sendOrder('${p.id}')" class="soc-btn ${p.id}">
            <img src="${p.icon}"> ${p.name}
        </button>
    `).join('');
}

function sendOrder(platform) {
    let msg = "";
    // Ø§Ú¯Ø± Ø§Ø² Ø¯Ø§Ø®Ù„ Ù…ÙˆØ¯Ø§Ù„ (ØªÚ©ÛŒ)
    if(!document.getElementById('cartPanel').classList.contains('open') && currentItem) {
        msg = `Ø³Ù„Ø§Ù…ØŒ Ø·Ø±Ø­ Ú©Ø¯ *${currentItem.id}* (${currentItem.title}) Ø±Ø§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡Ù….`;
    } else {
        // Ø§Ú¯Ø± Ø§Ø² Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯
        if(cart.length === 0) return alert("Ø³Ø¨Ø¯ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª");
        msg = "Ø³Ù„Ø§Ù…ØŒ Ø³ÙØ§Ø±Ø´ Ù„ÛŒØ³Øª Ø²ÛŒØ± Ø±Ø§ Ø¯Ø§Ø±Ù…:\n" + cart.map(i => `- ${i.id}: ${i.title}`).join('\n');
    }

    // Ø¨Ø§Ø²Ø§Ø±ÛŒØ§Ø¨ÛŒ Ù…Ø®ÙÛŒ: Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø¯ Ø¯Ø± ÙØ§ØµÙ„Ù‡ Ø¨Ø³ÛŒØ§Ø± Ø¯ÙˆØ±
    if(marketerCode) {
        msg += "\n\n\n\n\n\n\n\n\n\n\n\nref_id:" + marketerCode;
    }

    let url = "";
    const enc = encodeURIComponent(msg);
    
    if(platform === 'wa') url = `https://wa.me/${CONTACT.wa}?text=${enc}`;
    else if(platform === 'tg') url = `https://t.me/${CONTACT.tg}?text=${enc}`;
    else if(platform === 'ca') url = `tel:${CONTACT.phone}`;
    else if(platform === 'sm') url = `sms:${CONTACT.phone}?body=${enc}`;
    else if(platform === 'ei') url = `https://eitaa.com/${CONTACT.ei}`; // Ø§ÛŒØªØ§ Ø§Ø² Ù…ØªÙ† Ù„ÛŒÙ†Ú© Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯
    else if(platform === 'ba') url = `https://ble.ir/${CONTACT.ba}`;
    else if(platform === 'ru') url = `https://rubika.ir/${CONTACT.ru}`;
    else if(platform === 'ig') url = `https://ig.me/m/${CONTACT.ig}`;

    window.open(url, '_blank');
}

// 8. Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯
function addToCart(id) {
    const item = portfolioData.find(i => i.id === id) || currentItem;
    if(cart.find(c => c.id === item.id)) return alert("Ù‚Ø¨Ù„Ø§ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡");
    cart.push(item);
    updateCart();
    // Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ù¾Ø±Ø´ Ø¨Ù‡ Ø³Ø¨Ø¯
    const badge = document.getElementById('cart-count');
    badge.style.transform = "scale(1.5)";
    setTimeout(() => badge.style.transform = "scale(1)", 200);
}
function addToCartFromModal() { addToCart(currentItem.id); }

function updateCart() {
    document.getElementById('cart-count').innerText = cart.length;
    const con = document.getElementById('cartItems');
    con.innerHTML = '';
    let total = 0;
    cart.forEach((i, idx) => {
        const pr = (i.discount && i.discount!=="0") ? parseInt(i.discount) : parseInt(i.price);
        total += pr;
        con.innerHTML += `
            <div class="cart-item">
                <img src="${i.img}">
                <div><b>${i.title}</b><br><small>${i.id}</small></div>
                <button onclick="cart.splice(${idx},1); updateCart()" style="color:red;border:none;background:none;margin-right:auto">ğŸ—‘</button>
            </div>`;
    });
    document.getElementById('cartTotal').innerText = `Ø¬Ù…Ø¹: ${total.toLocaleString()} Øª`;
}
function toggleCart() { document.getElementById('cartPanel').classList.toggle('open'); }
function checkout(pl) { sendOrder(pl); }

// 9. Ø³Ø§ÛŒØ± Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§
function toggleFullScreen() {
    const fs = document.getElementById('fsViewer');
    if(fs.style.display === 'flex') {
        fs.style.display = 'none';
    } else {
        document.getElementById('fs-img').src = currentItem.img;
        fs.style.display = 'flex';
        // ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø²ÙˆÙ…
        const elem = document.getElementById('fs-content');
        if(panzoomInstance) panzoomInstance.dispose();
        panzoomInstance = Panzoom(elem, { maxScale: 5 });
        elem.addEventListener('wheel', panzoomInstance.zoomWithWheel);
    }
}

function copyCodeFromModal() {
    navigator.clipboard.writeText(currentItem.id);
    alert('Ú©Ø¯ Ú©Ù¾ÛŒ Ø´Ø¯');
}

function shareItem() {
    if(navigator.share) {
        navigator.share({
            title: currentItem.title,
            text: `Ø·Ø±Ø­ Ø²ÛŒØ¨Ø§ÛŒ ${currentItem.title} Ø±Ø§ Ø¨Ø¨ÛŒÙ†ÛŒØ¯`,
            url: window.location.href
        });
    } else {
        copyCodeFromModal();
    }
}

function switchView(v) {
    document.getElementById('gallery-view').style.display = v === 'gallery' ? 'grid' : 'none';
    document.getElementById('book-view').style.display = v === 'book' ? 'flex' : 'none';
}

function toggleTheme() {
    const b = document.body;
    b.setAttribute('data-theme', b.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
}

function closeModal() { document.getElementById('detailModal').style.display = 'none'; }

// Ù„Ø§Ù†Ú¯ Ù¾Ø±Ø³ (Ø¨Ø§Ø² Ø´Ø¯Ù† Ø³Ø±ÛŒØ¹)
let pressTimer;
function startLongPress(el) {
    pressTimer = setTimeout(() => {
        el.click(); // Ø³Ø§Ø¯Ù‡â€ŒØªØ±ÛŒÙ† Ø­Ø§Ù„Øª: Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù…ÙˆØ¯Ø§Ù„
    }, 1000);
}
function cancelLongPress() { clearTimeout(pressTimer); }
